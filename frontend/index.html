<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Tailor - Cyber-Professional Matrix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Required Libraries (Preserved) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        /* Cyber-Professional Matrix Theme */
        :root {
            /* Light Theme Palette (Fallback/Toggle) */
            --bg-primary: #f8fafc;        /* slate-50 */
            --bg-secondary: #ffffff;      /* white */
            --bg-tertiary: #e2e8f0;       /* slate-200 */
            --text-primary: #0f172a;      /* slate-900 */
            --text-secondary: #475569;    /* slate-600 */
            --border-color: #cbd5e1;      /* slate-300 */
            --accent-primary: #3b82f6;    /* blue-500 */
            --accent-primary-hover: #2563eb; 
            --accent-primary-rgb: 59, 130, 246;
        }

        .dark-theme {
            /* Deep Charcoal / Electric Blue Aesthetic */
            --bg-primary: #050510;        /* Near Black */
            --bg-secondary: #111827;      /* Dark Panel BG */
            --bg-tertiary: #1f2937;       /* Input/History/Element BG */
            --text-primary: #e5e7eb;      /* Cool Gray Text */
            --text-secondary: #9ca3af;    /* Secondary Gray Text */
            --border-color: #374151;      /* Darker border */
            --accent-primary: #3b82f6;    /* Electric Blue (Main Action) */
            --accent-primary-hover: #60a5fa; 
            --accent-primary-rgb: 59, 130, 246;
            --accent-secondary-color: #10b981; /* Emerald for success */
        }

        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.4s, color 0.4s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Subtle grid background pattern */
        .bg-matrix {
            background-image: linear-gradient(0deg, var(--bg-primary) 0%, transparent 10%), 
                              linear-gradient(90deg, #1f2937 1px, transparent 1px), 
                              linear-gradient(180deg, #1f2937 1px, transparent 1px);
            background-size: 50px 50px;
        }
        
        /* Data Panel Card Style */
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
            /* Inner shadow for the 'panel' look */
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.4), 0 5px 15px rgba(0, 0, 0, 0.5); 
        }

        /* Main Action Button - Neon/Holographic Gradient */
        .action-btn {
            background-image: linear-gradient(90deg, #1e3a8a 0%, var(--accent-primary) 100%);
            color: white;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* Stronger glow */
            box-shadow: 0 0 20px rgba(var(--accent-primary-rgb), 0.5); 
            border: none;
        }
        .action-btn:hover {
            transform: translateY(-1px) scale(1.01);
            opacity: 0.95;
            box-shadow: 0 0 30px rgba(var(--accent-primary-rgb), 0.8);
        }

        /* Secondary Button Styling - Tool Buttons */
        .secondary-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        .secondary-btn:hover {
            background-color: var(--bg-secondary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: 0 0 5px rgba(var(--accent-primary-rgb), 0.5);
        }

        /* Input/Textarea/Output Box Styles - Focused glow */
        textarea, .output-box, .file-list li {
            background-color: var(--bg-tertiary) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        textarea:focus {
            border-color: var(--accent-primary) !important;
            box-shadow: 0 0 8px rgba(var(--accent-primary-rgb), 0.8) !important; /* Glow on focus */
            outline: none;
        }
        
        /* Upload Box Design */
        .upload-box {
            border-color: var(--border-color);
            color: var(--text-secondary);
            background-color: var(--bg-tertiary);
        }
        .upload-box.drag-over, .upload-box:hover {
            border-color: var(--accent-primary);
            background-color: rgba(var(--accent-primary-rgb), 0.1);
            color: var(--accent-primary);
        }

        /* Step Indicators */
        .step-indicator {
            box-shadow: 0 0 10px rgba(var(--accent-primary-rgb), 0.5);
        }

        /* Feedback Section - Emphasized Borders */
        .feedback-box { 
            border-left: 5px solid; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        .feedback-box.strengths { border-color: var(--accent-secondary-color); } /* Emerald */
        .feedback-box.missing { border-color: #f59e0b; } /* Amber */
        .feedback-box.suggestions { border-color: var(--accent-primary); } /* Blue */
        
        .feedback-box li {
            background-color: var(--bg-tertiary) !important;
            border: none !important; 
        }

        /* ATS Score Gauge Colors - Neon Effect */
        #atsScoreCircle {
            transition: stroke-dashoffset 1s cubic-bezier(0.25, 1, 0.5, 1);
            filter: drop-shadow(0 0 5px currentColor); /* Neon glow effect */
        }
        #atsScoreText {
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
        }
        
        /* Progress Bars */
        .ats-progress-bar-bg { background-color: var(--border-color); }

        /* Spinner for High-Tech look */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Animation */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
    </style>
</head>
<body class="dark-theme antialiased bg-matrix">
    <!-- Header: Sharp and Prominent -->
    <header class="sticky top-0 z-40 bg-slate-900/90 backdrop-blur-sm border-b border-slate-700 shadow-2xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo: AI Scanner -->
                <a href="/" class="flex items-center gap-3 text-2xl font-black tracking-widest text-white">
                    <div class="bg-blue-600/70 p-3 rounded-xl step-indicator">
                        <!-- Binary Code Icon for AI Scan -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/><path d="M5 5l2 2"/><path d="M5 19l2-2"/><path d="M19 5l-2 2"/><path d="M19 19l-2-2"/></svg>
                    </div>
                    <span class="text-blue-400">ATS</span> <span class="text-white">OPTIMIZER</span>
                </a>
                <!-- Navigation & Actions -->
                <div class="flex items-center space-x-2 sm:space-x-4">
                     <!-- History Button -->
                     <button id="historyBtn" class="p-3 rounded-full text-blue-400 hover:bg-slate-800 focus:outline-none transition duration-200 hover:text-white">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                    </button>
                    <!-- Theme Toggle -->
                    <button id="theme-toggle" class="p-3 rounded-full text-slate-400 hover:bg-slate-800 focus:outline-none transition duration-200">
                        <svg id="moon-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                        <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- History Panel -->
    <div id="historyPanel" class="fixed top-0 left-0 w-80 h-full z-50 transform -translate-x-full transition-transform duration-300 bg-slate-900 shadow-2xl border-r border-slate-700">
        <div class="flex items-center justify-between p-4 border-b border-slate-700">
            <h2 class="text-xl font-semibold text-white">Analysis History</h2>
            <button id="closeHistoryBtn" class="p-1 rounded-full text-slate-400 hover:bg-slate-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <ul id="historyList" class="p-4 space-y-3 overflow-y-auto h-[calc(100%-65px)]">
            <!-- History items will be injected here -->
        </ul>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
        
        <!-- Hero Section (Action-Oriented) -->
        <section class="text-center mb-16">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-white tracking-tight mb-4">
                <span class="text-blue-400">DEFEAT THE BOTS</span>. LAND THE INTERVIEW.
            </h1>
            <p class="text-lg sm:text-xl text-slate-400 max-w-4xl mx-auto font-light">
                Our Generative AI engine scans, analyzes, and optimizes your resume against any job description, guaranteeing maximum **Applicant Tracking System (ATS)** compatibility.
            </p>
        </section>

        <!-- Main App Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-10 items-start">
            
            <!-- Left Column (Inputs & Actions): Takes 2/5 width, sticky for better UX -->
            <div class="space-y-8 lg:col-span-2 lg:sticky lg:top-24">
                
                <!-- Step 1 & 2: Input Card - Unified Data Entry Panel -->
                <div class="card p-8 rounded-2xl border-blue-900/50">
                    
                    <!-- Step 1: Upload -->
                    <h2 class="text-xl font-semibold text-white mb-5 flex items-center">
                        <span class="w-8 h-8 flex items-center justify-center bg-blue-500/20 text-blue-400 rounded-lg font-bold text-lg mr-3 border border-blue-500 step-indicator">1</span>
                        DATA INPUT: Resume File
                    </h2>
                    <div id="uploadBox" class="upload-box flex flex-col items-center justify-center p-10 rounded-xl border-2 border-dashed cursor-pointer text-blue-400 hover:shadow-lg hover:shadow-blue-500/10 transition duration-300">
                        <input type="file" id="resume" accept=".txt,.pdf,.docx" class="hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                        <span class="font-medium text-lg">DRAG & DROP or CLICK to load asset</span>
                        <span class="text-sm mt-1 text-slate-500">Supported formats: PDF, DOCX, TXT</span>
                    </div>
                    <ul class="file-list list-none mt-4 w-full" id="fileList"></ul>

                    <div class="border-t border-slate-700 my-8"></div>
                    
                    <!-- Step 2: Job Description -->
                    <h2 class="text-xl font-semibold text-white mb-5 flex items-center">
                        <span class="w-8 h-8 flex items-center justify-center bg-blue-500/20 text-blue-400 rounded-lg font-bold text-lg mr-3 border border-blue-500 step-indicator">2</span>
                        DATA INPUT: Target Job Description
                    </h2>
                    <textarea id="jobDescription" rows="8" placeholder="Paste the full job description text here..." class="w-full p-4 rounded-xl text-sm transition-all focus:ring-4"></textarea>
                </div>

                <!-- Step 3: Analysis & Generation -->
                <div id="generateArea" class="card p-8 rounded-2xl border-blue-900/50">
                    <h2 class="text-xl font-semibold text-white mb-5 flex items-center">
                        <span class="w-8 h-8 flex items-center justify-center bg-blue-500/20 text-blue-400 rounded-lg font-bold text-lg mr-3 border border-blue-500 step-indicator">3</span>
                        EXECUTE OPTIMIZATION
                    </h2>
                    <div class="mb-6">
                        <label class="flex items-start gap-3 text-sm text-slate-400">
                            <input type="checkbox" id="preserveTemplateChk" class="mt-1 h-5 w-5 rounded-md border-slate-600 bg-slate-800 text-blue-500 focus:ring-blue-500/80" />
                            <span class="leading-relaxed">Preserve resume structural integrity (AI rewrites only content: summary, skills, and bullet points).</span>
                        </label>
                    </div>
                    <button id="generateBtn" class="action-btn w-full px-8 py-4 rounded-xl font-extrabold text-lg flex items-center justify-center gap-3 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9l-3 3 3 3"/></svg>
                        INITIATE ATS ANALYSIS
                    </button>
                    <!-- AI Generate button will be injected here after analysis -->
                </div>
            </div>

            <!-- Right Column (Results & Feedback): Takes 3/5 width -->
            <div class="space-y-8 lg:col-span-3">
                
                <!-- ATS Score Section - Visual Hero -->
                <div class="card p-8 rounded-2xl border-blue-900/50">
                    <h2 class="text-2xl font-bold mb-6 text-white flex items-center border-b border-slate-700/50 pb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-emerald-400"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>
                        ATS COMPATIBILITY MATRIX
                    </h2>
                    <div id="atsScoreContainer" class="hidden fade-in">
                        <div class="flex flex-col md:flex-row items-center gap-8">
                            <!-- Score Gauge -->
                            <div class="relative w-40 h-40 flex-shrink-0">
                                <svg class="w-full h-full" viewBox="0 0 36 36" transform="rotate(-90)">
                                    <path class="stroke-current text-slate-700" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3.5" />
                                    <path id="atsScoreCircle" class="stroke-current transition-all duration-1000 ease-out" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3.5" stroke-dasharray="100, 100" stroke-dashoffset="100" stroke-linecap="round" />
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span id="atsScoreText" class="text-5xl font-extrabold text-white">0%</span>
                                    <span id="atsScoreRating" class="text-sm font-semibold mt-1"></span>
                                </div>
                            </div>
                            <!-- Breakdown Bars -->
                            <div id="atsBreakdownContainer" class="w-full flex-1 space-y-4"></div>
                        </div>
                    </div>
                    <div id="atsSkeleton">
                        <div class="space-y-4">
                           <div class="h-5 w-1/2 skeleton mb-4"></div>
                           <div class="h-4 w-full skeleton"></div>
                           <div class="h-4 w-11/12 skeleton"></div>
                           <div class="h-4 w-5/6 skeleton"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Tailored Resume Section - Output Console -->
                <div class="card p-8 rounded-2xl border-blue-900/50">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white">GENERATED OUTPUT: Optimized Document</h2>
                        <div class="flex flex-wrap gap-3">
                            <button id="copyBtn" class="secondary-btn flex-shrink-0 px-4 py-2 rounded-lg font-semibold text-sm">Copy Text</button>
                            <button id="downloadPdfBtn" class="secondary-btn flex-shrink-0 px-4 py-2 rounded-lg font-semibold text-sm">Download PDF</button>
                            <button id="downloadDocxBtn" class="secondary-btn flex-shrink-0 px-4 py-2 rounded-lg font-semibold text-sm">Download DOCX</button>
                        </div>
                    </div>
                    
                    <div id="tailoredResumeContent" class="output-box text-sm leading-relaxed whitespace-pre-wrap p-6 rounded-xl min-h-[300px] border-slate-700 font-mono text-slate-300">
                        <div class="flex flex-col items-center justify-center h-full text-slate-600">
                             <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mb-4 text-slate-700"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                             Awaiting Analysis: Your optimized document will load here.
                        </div>
                    </div>
                    
                    <div id="resumeSkeleton" class="p-6 hidden">
                          <div class="skeleton h-6 w-3/4 mb-4"></div>
                          <div class="skeleton h-4 w-full mb-2"></div>
                          <div class="skeleton h-4 w-11/12 mb-2"></div>
                          <div class="skeleton h-4 w-5/6"></div>
                          <div class="skeleton h-4 w-full mb-2 mt-4"></div>
                          <div class="skeleton h-4 w-10/12 mb-2"></div>
                    </div>
                </div>

                <!-- AI-Powered Feedback Section - Actionable Data Points -->
                <div id="feedbackContainer" class="space-y-6">
                    <div class="feedback-box strengths card rounded-2xl p-6 hidden fade-in" id="strengthsBox">
                        <h3 class="text-xl font-semibold mb-3 flex items-center text-emerald-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            KEY STRENGTHS (SUCCESS PARAMETERS)
                        </h3>
                        <ul id="strengthsList" class="list-none space-y-3"></ul>
                    </div>
                    <div class="feedback-box missing card rounded-2xl p-6 hidden fade-in" id="missingBox">
                         <h3 class="text-xl font-semibold mb-3 flex items-center text-amber-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                             MISSING KEYWORDS (CRITICAL VULNERABILITIES)
                         </h3>
                         <ul id="missingList" class="list-none space-y-3"></ul>
                    </div>
                    <div class="feedback-box suggestions card rounded-2xl p-6 hidden fade-in" id="suggestionsBox">
                         <h3 class="text-xl font-semibold mb-3 flex items-center text-blue-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                             SMART OPTIMIZATIONS (ACTION ITEMS)
                         </h3>
                         <ul id="suggestionsList" class="list-none space-y-3"></ul>
                    </div>
                </div>

                <!-- Extra AI Features -->
                <div class="card p-8 rounded-2xl border-blue-900/50">
                    <h2 class="text-2xl font-bold mb-5 text-white">AI COMMAND SUITE</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button id="summarizeBtn" class="secondary-btn px-4 py-3 rounded-lg font-semibold text-base">JD Summary</button>
                        <button id="coverLetterBtn" class="secondary-btn px-4 py-3 rounded-lg font-semibold text-base">Cover Letter Draft</button>
                        <button id="questionsBtn" class="secondary-btn px-4 py-3 rounded-lg font-semibold text-base">Interview Prep Qs</button>
                    </div>
                    <div id="geminiOutputContainer" class="hidden mt-6">
                        <h3 id="geminiOutputTitle" class="text-xl font-semibold mb-3 text-blue-400"></h3>
                        <div id="geminiOutput" class="output-box p-6 rounded-xl text-sm text-slate-300"></div>
                        <div id="geminiOutputSkeleton" class="skeleton h-32 mt-4 hidden"></div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Toast Message - Action Confirmation -->
    <div id="message-box" class="fixed bottom-6 right-6 px-5 py-3 rounded-xl shadow-2xl font-semibold text-white transition-all duration-300 opacity-0 transform translate-y-4 pointer-events-none z-50"></div>

    <script>
        // --- DOM Element Selectors ---
        const themeToggle = document.getElementById('theme-toggle');
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        const body = document.body;
        const generateBtn = document.getElementById('generateBtn');
        const summarizeBtn = document.getElementById('summarizeBtn');
        const coverLetterBtn = document.getElementById('coverLetterBtn');
        const questionsBtn = document.getElementById('questionsBtn');
        const historyBtn = document.getElementById('historyBtn');
        const historyPanel = document.getElementById('historyPanel');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const historyList = document.getElementById('historyList');
        const resumeInput = document.getElementById('resume');
        const uploadBox = document.getElementById('uploadBox');
        const jobDescInput = document.getElementById('jobDescription');
        const tailoredResumeContent = document.getElementById('tailoredResumeContent');
        const strengthsBox = document.getElementById('strengthsBox');
        const missingBox = document.getElementById('missingBox');
        const suggestionsBox = document.getElementById('suggestionsBox');
        const strengthsList = document.getElementById('strengthsList');
        const missingList = document.getElementById('missingList');
        const suggestionsList = document.getElementById('suggestionsList');
        const fileList = document.getElementById('fileList');
        const geminiOutputContainer = document.getElementById('geminiOutputContainer');
        const geminiOutputTitle = document.getElementById('geminiOutputTitle');
        const geminiOutput = document.getElementById('geminiOutput');
        const geminiOutputSkeleton = document.getElementById('geminiOutputSkeleton');
        const resumeSkeleton = document.getElementById('resumeSkeleton');
        const atsScoreContainer = document.getElementById('atsScoreContainer');
        const atsSkeleton = document.getElementById('atsSkeleton');

        let tailoredResumeText = '';
    // Force plain text resume output (backend /resume/api/generate?output_format=text)
    const FORCE_PLAIN_TEXT_OUTPUT = true; // set to false if you want JSON with ATS in a single call

        // --- Plain Text Cleaner ---
        function cleanPlainResume(raw) {
            if (!raw) return '';
            let text = raw.trim();
            // If the whole thing looks like JSON, try to parse and extract enhanced_resume
            const firstBrace = text.indexOf('{');
            const lastBrace = text.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace > firstBrace) {
                const maybeJson = text.slice(firstBrace, lastBrace + 1);
                try {
                    const parsed = JSON.parse(maybeJson);
                    if (parsed && typeof parsed === 'object') {
                        if (parsed.enhanced_resume && typeof parsed.enhanced_resume === 'string') {
                            return parsed.enhanced_resume.trim();
                        }
                    }
                } catch (_) {
                    // ignore parse error, continue with regex extraction attempt
                    const match = /"enhanced_resume"\s*:\s*"([\s\S]*?)"\s*,?\n/i.exec(maybeJson);
                    if (match) {
                        let candidate = match[1]
                            .replace(/\\n/g, '\n')
                            .replace(/\\"/g, '"');
                        return candidate.trim();
                    }
                }
            }
            // Strip leading JSON-like key if model returned only that section
            if (/^"?enhanced_resume"?\s*:/.test(text.toLowerCase())) {
                text = text.replace(/^"?enhanced_resume"?\s*:\s*/i, '');
                // Remove surrounding quotes if present
                if (text.startsWith('"') && text.endsWith('"')) {
                    text = text.slice(1, -1);
                }
                text = text.replace(/\\n/g, '\n').replace(/\\"/g, '"');
            }
            // Remove trailing unmatched braces/brackets if leftover
            if ((text.match(/\{/g) || []).length !== (text.match(/\}/g) || []).length) {
                // crude trimming of stray braces at ends
                text = text.replace(/^\{+/,'').replace(/}+$/,'');
            }
            // If it still contains many JSON keys, heuristically remove lines with a colon followed by quote + bracket patterns
            const lines = text.split(/\r?\n/);
            if (lines.filter(l => /"[A-Za-z_ ]+"\s*:/.test(l)).length > 3) {
                const filtered = lines.filter(l => !/^[\s\{\}\[\]]*$/.test(l) && !/"[A-Za-z_ ]+"\s*:/.test(l));
                if (filtered.length > 0) text = filtered.join('\n');
            }
            return text.trim();
        }
        
        // --- Mock Backend Endpoints (Preserved) ---
        const BACKEND_GENERATE_URL = '/resume/generate'; 
        const BACKEND_ANALYZE_URL = '/resume/api/analyze';
        const BACKEND_AI_GENERATE_URL = '/resume/api/generate';
        const BACKEND_ENHANCE_UPLOAD_URL = '/resume/enhance_resume';

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark'; 
            setTheme(savedTheme);
            loadHistory();
            setInitialUIState();
        });

        themeToggle.addEventListener('click', () => {
            const currentTheme = body.classList.contains('dark-theme') ? 'light' : 'dark';
            setTheme(currentTheme);
        });
        
        historyBtn.addEventListener('click', () => historyPanel.classList.add('translate-x-0'));
        closeHistoryBtn.addEventListener('click', () => historyPanel.classList.remove('translate-x-0'));

        uploadBox.addEventListener('click', () => resumeInput.click());
        resumeInput.addEventListener('change', handleFileSelect);
        ['dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadBox.addEventListener(eventName, handleDragDrop, false);
        });

        generateBtn.addEventListener('click', handleAnalyzeClick);
        summarizeBtn.addEventListener('click', () => handleGeminiFeature('Job Description Summary', generateSummary));
        coverLetterBtn.addEventListener('click', () => handleGeminiFeature('Draft Cover Letter', draftCoverLetter));
        questionsBtn.addEventListener('click', () => handleGeminiFeature('Interview Questions', generateQuestions));
        
        document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
        document.getElementById('downloadPdfBtn').addEventListener('click', downloadAsPDF);
        document.getElementById('downloadDocxBtn').addEventListener('click', downloadAsDOCX);

        // --- Core Functions ---
        
        function setInitialUIState() {
            atsSkeleton.classList.remove('hidden');
            atsScoreContainer.classList.add('hidden');
        }
        
        function setTheme(theme) {
            if (theme === 'dark') {
                body.classList.add('dark-theme');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                body.classList.remove('dark-theme');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
            localStorage.setItem('theme', theme);
        }
        
        function handleFileSelect(e) {
            const files = Array.from(e.target.files || []);
            if (files.length > 0) renderFileList(files);
        }

        function handleDragDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            if (e.type === 'dragover') {
                uploadBox.classList.add('drag-over');
            } else if (e.type === 'dragleave') {
                uploadBox.classList.remove('drag-over');
            } else if (e.type === 'drop') {
                uploadBox.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files || []);
                if (files.length > 0) {
                    resumeInput.files = e.dataTransfer.files;
                    renderFileList(Array.from(resumeInput.files));
                }
            }
        }

        function renderFileList(files) {
            fileList.innerHTML = '';
            if (files.length > 0) {
                const file = files[0];
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-3 rounded-xl text-sm bg-slate-800 border-slate-700 shadow-inner mt-2';
                li.innerHTML = `<span class="truncate text-slate-300 font-medium">${file.name}</span> <button class="remove-file ml-2 text-red-400 hover:text-red-300 font-bold p-1 rounded-full bg-slate-700/50" data-index="0">Ã—</button>`;
                li.querySelector('.remove-file').addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    resumeInput.value = ''; 
                    renderFileList([]); 
                });
                fileList.appendChild(li);
            }
        }
        
        async function getFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error("Failed to read file."));
                reader.readAsText(file);
            });
        }
        
        function showMessage(msg, type = "info") {
            const box = document.getElementById("message-box");
            box.textContent = msg;
            const colors = { 
                success: '#10b981', 
                warning: '#f59e0b', 
                danger: '#ef4444', 
                info: '#3b82f6' 
            };
            box.style.backgroundColor = colors[type] || '#333';
            box.classList.remove('opacity-0', 'translate-y-4');
            box.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                box.classList.remove('opacity-100', 'translate-y-0');
                box.classList.add('opacity-0', 'translate-y-4');
            }, 3000);
        }

        // --- Analysis and Generation Workflow ---
    async function handleAnalyzeClick() {
            const file = resumeInput.files[0];
            const jobDesc = jobDescInput.value.trim();

            if (!file) return showMessage("Please upload your resume.", "warning");
            if (!jobDesc) return showMessage("Please paste the job description.", "warning");
            
            setLoadingState(true, 'analyze');
            
            try {
                let data;
                try {
                    const form = new FormData();
                    form.append('file', file);
                    const url = `${BACKEND_ANALYZE_URL}?job_description=${encodeURIComponent(jobDesc)}`;
                    const resp = await fetch(url, { method: 'POST', body: form });
                    if(!resp.ok) throw new Error(`Analyze failed ${resp.status}`);
                    data = await resp.json();
                } catch (e) {
                    console.warn('Analyze backend failed, falling back to mock:', e);
                    data = await mockApiResponse('analyze');
                }
                
                const originalResume = data.extracted_text || await getFileContent(file);
                tailoredResumeText = originalResume; 
                
                // Highlight irrelevant sections (red/danger color)
                const redPhrases = sanitizePhrases(data.unwanted_sections || []);
                const highlighted = highlightPhrasesSafely(originalResume, redPhrases, `background-color:rgba(239,68,68,0.2); color: #fca5a5;`);
                
                tailoredResumeContent.innerHTML = highlighted;
                tailoredResumeContent.classList.remove('hidden');
                
                generateBtn.dataset.matched = JSON.stringify(data.matched_sections || []);
                ensureAIGenerateButton();
                showMessage('Analysis complete. Click AI Generate to tailor.', 'success');

            } catch (err) {
                console.error('Analyze failed', err);
                showMessage('Analysis failed. See console for details.', 'danger');
            } finally {
                setLoadingState(false);
            }
        }

        function ensureAIGenerateButton() {
            if (document.getElementById('aiGenerateBtn')) return;
            const btn = document.createElement('button');
            btn.id = 'aiGenerateBtn';
            btn.className = 'action-btn w-full px-8 py-4 rounded-xl font-extrabold text-lg flex items-center justify-center gap-3 mt-4 transition duration-300';
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg> AI GENERATE OPTIMIZED VERSION`;
            btn.addEventListener('click', handleAIGenerateClick);
            generateBtn.insertAdjacentElement('afterend', btn);
        }

    async function handleAIGenerateClick() {
            const file = resumeInput.files[0];
            const jobDesc = jobDescInput.value.trim();
            const matched = JSON.parse(generateBtn.dataset.matched || '[]');

            if (!file || !jobDesc) return showMessage("Inputs are missing.", "warning");

            setLoadingState(true, 'generate');
            
            try {
                let data;
                const form = new FormData();
                form.append('file', file);
                const preserve = document.getElementById('preserveTemplateChk')?.checked ? 'true' : 'false';
                const matchedParam = encodeURIComponent(JSON.stringify(matched));

                if (FORCE_PLAIN_TEXT_OUTPUT) {
                    // Hard plain-text path: request backend with plain=1 and always treat response as raw text
                    const url = `${BACKEND_AI_GENERATE_URL}?job_description=${encodeURIComponent(jobDesc)}&matched_sections=${matchedParam}&preserve_template=${preserve}&plain=1`;
                    try {
                        const resp = await fetch(url, { method: 'POST', body: form });
                        if(!resp.ok) throw new Error(`Generate failed ${resp.status}`);
                        let raw = await resp.text();
                        // Defensive: if backend unexpectedly returned JSON, extract enhanced_resume
                        if (raw.trim().startsWith('{') && raw.includes('enhanced_resume')) {
                            try {
                                const parsed = JSON.parse(raw);
                                if (parsed && typeof parsed === 'object' && parsed.enhanced_resume) {
                                    raw = parsed.enhanced_resume;
                                }
                            } catch (_) { /* ignore parse error */ }
                        }
                        const cleaned = cleanPlainResume(raw);
                        data = { enhanced_resume: cleaned, ats_breakdown: {}, matched_sections: matched, feedback: {}, missing_keywords: [] };
                    } catch (e) {
                        console.warn('Plain text generate failed, using mock fallback:', e);
                        const mock = await mockApiResponse('generate');
                        data = { enhanced_resume: cleanPlainResume(mock.enhanced_resume), ats_breakdown: {}, matched_sections: matched, feedback: {}, missing_keywords: [] };
                    }
                } else {
                    // JSON path (detailed ATS mode)
                    try {
                        const url = `${BACKEND_AI_GENERATE_URL}?job_description=${encodeURIComponent(jobDesc)}&matched_sections=${matchedParam}&preserve_template=${preserve}&output_format=json`;
                        const resp = await fetch(url, { method: 'POST', body: form });
                        if(!resp.ok) throw new Error(`Generate failed ${resp.status}`);
                        data = await resp.json();
                        if (!data || !data.enhanced_resume) throw new Error('Malformed JSON response');
                    } catch (e) {
                        console.warn('JSON generate failed, using mock fallback:', e);
                        data = await mockApiResponse('generate');
                    }
                }

                populateResults(data);
                saveToHistory({ data, jobDesc, timestamp: Date.now() });
                showMessage('AI tailoring complete! ' + (FORCE_PLAIN_TEXT_OUTPUT ? 'Plain text ready.' : 'ATS score updated.'), 'success');
            } catch (err) {
                console.error('AI Generate failed', err);
                showMessage('AI generation failed.', 'danger');
            } finally {
                setLoadingState(false);
            }
        }

        // --- Other AI Features (Mocked) ---

        async function handleGeminiFeature(title, featureFunction) {
            const resumeFile = resumeInput.files[0];
            const jobDesc = jobDescInput.value.trim();
            if (!resumeFile || !jobDesc) return showMessage("Please provide resume and job description.", "warning");
            
            geminiOutputContainer.classList.remove('hidden');
            geminiOutputTitle.textContent = title;
            geminiOutput.classList.add('hidden');
            geminiOutputSkeleton.classList.remove('hidden');

            try {
                const resumeText = await getFileContent(resumeFile);
                
                const generatedContent = await featureFunction(resumeText, jobDesc); 
                geminiOutput.innerHTML = generatedContent.replace(/\n/g, '<br>');
            } catch (error) {
                geminiOutput.textContent = `ERROR: ${error.message}`;
                showMessage("Failed to generate content.", "danger");
            } finally {
                geminiOutput.classList.remove('hidden');
                geminiOutputSkeleton.classList.add('hidden');
            }
        }
        
        async function generateSummary(resumeText, jobDesc) { 
            await new Promise(r => setTimeout(r, 1000));
            return "ANALYSIS COMPLETE: Job Description Summary: This role is primarily focused on **scalable web application development** utilizing **Python** (Django/Flask) and JavaScript. Core requirements include **RESTful API** design, **CI/CD pipeline** management, and collaboration within an agile environment. Keywords: Python, RESTful API, Scalable, CI/CD, Django."; 
        }
        async function draftCoverLetter(resumeText, jobDesc) { 
            await new Promise(r => setTimeout(r, 1000));
            return `INITIATING COVER LETTER SEQUENCE...\n\n[ACCESS_DATE] 2024-10-08\n\n[RECIPIENT_MANAGER_NAME]\n\nSUBJECT: Application for Software Engineer (Reference ATS-Opt-88)\n\nMy 5+ years in **Python** and **Django** directly align with the core competencies required for this role. I specialize in designing high-availability **RESTful APIs** and deploying solutions via robust **CI/CD pipelines**, consistently improving operational efficiency (e.g., reducing downtime by 30%). I am confident my profile represents an **Excellent Fit** (ATS Score: 95%).\n\n[SIGNATURE_BLOCK]`; 
        }
        async function generateQuestions(resumeText, jobDesc) { 
            await new Promise(r => setTimeout(r, 1000));
            return "SIMULATED INTERVIEW PROTOCOL START:\n\n1. SCALABILITY: Describe an architecture change you implemented to handle a 5x increase in user traffic for a **scalable web application**.\n2. API DESIGN: How do you prioritize security and rate-limiting when building a public-facing **RESTful API**?\n3. DEVOPS: Detail your experience implementing **CI/CD pipelines** (e.g., using Jenkins, GitHub Actions) for continuous deployment of **Python** services."; 
        }

        // --- UI State Management ---
        function setLoadingState(isLoading, stage = '') {
            const aiGenerateBtn = document.getElementById('aiGenerateBtn');
            const spinnerHtml = `<div class="spinner border-slate-100 border-l-transparent"></div> Processing...`;
            
            if(isLoading){
                if(stage === 'analyze'){
                    generateBtn.disabled = true;
                    generateBtn.innerHTML = spinnerHtml.replace('Processing', 'ANALYZING INPUTS');
                } else if (stage === 'generate' && aiGenerateBtn) {
                    aiGenerateBtn.disabled = true;
                    aiGenerateBtn.innerHTML = spinnerHtml.replace('Processing', 'GENERATING OPTIMIZED DOCUMENT');
                }
                resumeSkeleton.classList.remove('hidden');
                atsSkeleton.classList.remove('hidden');
                tailoredResumeContent.classList.add('hidden');
                atsScoreContainer.classList.add('hidden');
                [strengthsBox, missingBox, suggestionsBox].forEach(el => el.classList.add('hidden'));
            } else {
                generateBtn.disabled = false;
                generateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9l-3 3 3 3"/></svg> INITIATE ATS ANALYSIS`;
                if(aiGenerateBtn){
                    aiGenerateBtn.disabled = false;
                    aiGenerateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg> AI GENERATE OPTIMIZED VERSION`;
                }
                resumeSkeleton.classList.add('hidden');
                atsSkeleton.classList.add('hidden');
            }
        }
        
        function populateResults(data) {
            tailoredResumeText = data.enhanced_resume || tailoredResumeText || '';
            // If plain text mode with no ATS breakdown, suppress ATS & feedback UI
            const noAts = FORCE_PLAIN_TEXT_OUTPUT && (!data.ats_breakdown || Object.keys(data.ats_breakdown).length === 0);
            const greenPhrases = noAts ? [] : sanitizePhrases(data.matched_sections || []);
            const display = highlightPhrasesSafely(tailoredResumeText, greenPhrases, `background-color:rgba(16,185,129,0.2); color: #6ee7b7;`);
            tailoredResumeContent.innerHTML = display;
            tailoredResumeContent.classList.remove('hidden');
            if (noAts) {
                atsScoreContainer.classList.add('hidden');
                strengthsBox.classList.add('hidden');
                missingBox.classList.add('hidden');
                suggestionsBox.classList.add('hidden');
            } else {
                renderAtsChart(data.ats_breakdown || {});
                updateFeedbackList(strengthsList, strengthsBox, data.feedback?.strengths || [], 'text-emerald-400');
                updateFeedbackList(missingList, missingBox, data.missing_keywords || [], 'text-amber-400');
                updateFeedbackList(suggestionsList, suggestionsBox, data.feedback?.suggestions || [], 'text-blue-400', true);
                atsScoreContainer.classList.remove('hidden');
            }
        }

        // --- Highlighting & Rendering ---
        function sanitizePhrases(phrases) {
            return (phrases || []).map(p => (p || '').trim()).filter(p => p && p.length > 2);
        }

        function highlightPhrasesSafely(text, phrases, inlineStyle) {
            const plain = (text || '').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
            if (!phrases || phrases.length === 0) return plain;
            const escaped = phrases.map(p => p.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).sort((a, b) => b.length - a.length);
            if (escaped.length === 0) return plain;
            const re = new RegExp(`(${escaped.join('|')})`, 'gi');
            return plain.replace(re, match => `<span class="highlighted-keyword" style="${inlineStyle}">${match}</span>`);
        }
        
        function updateFeedbackList(listElement, boxElement, items, colorClass, isSuggestions = false) {
            listElement.innerHTML = "";
            if (items && items.length > 0) {
                items.forEach(itemText => {
                    const li = document.createElement("li");
                    li.className = 'p-3 rounded-lg text-sm flex justify-between items-center';
                    li.innerHTML = `<span class="text-slate-300">${itemText}</span>`;
                    if (isSuggestions) {
                        li.innerHTML += `<button class="copy-suggestion flex-shrink-0 ml-2 p-1 text-slate-500 hover:${colorClass} rounded transition duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                        </button>`;
                        li.querySelector('.copy-suggestion').addEventListener('click', () => {
                            const tempInput = document.createElement('textarea');
                            tempInput.value = itemText;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            showMessage("Suggestion copied!", "success");
                        });
                    }
                    listElement.appendChild(li);
                });
                boxElement.classList.remove('hidden');
            } else {
                boxElement.classList.add('hidden');
            }
        }
        
        function renderAtsChart(breakdown) {
            const scoreTextEl = document.getElementById('atsScoreText');
            const scoreRatingEl = document.getElementById('atsScoreRating');
            const scoreCircleEl = document.getElementById('atsScoreCircle');
            const breakdownContainer = document.getElementById('atsBreakdownContainer');

            const data = Object.values(breakdown);
            const totalScore = data.length > 0 ? Math.round(data.reduce((a, b) => a + b, 0) / data.length) : 0;
            
            // Animate score text
            let currentScore = 0;
            const counter = setInterval(() => {
                currentScore = Math.min(currentScore + 1, totalScore);
                scoreTextEl.textContent = `${currentScore}%`;
                if(currentScore >= totalScore) clearInterval(counter);
            }, 10);

            // Set rating and color
            let rating = '', ringColor = 'text-red-500';
            if (totalScore < 50) { rating = 'VULNERABLE'; ringColor = 'text-red-500'; }
            else if (totalScore < 80) { rating = 'OPTIMIZED'; ringColor = 'text-amber-400'; }
            else { rating = 'ATS SECURE'; ringColor = 'text-emerald-400'; }
            scoreRatingEl.textContent = rating;
            scoreRatingEl.className = `text-sm font-semibold mt-1 ${ringColor}`;
            scoreCircleEl.className = `stroke-current ${ringColor} transition-all duration-1000 ease-out`;

            // Update gauge
            scoreCircleEl.style.strokeDashoffset = 100 - totalScore;

            // Populate breakdown
            breakdownContainer.innerHTML = '';
            Object.entries(breakdown).forEach(([label, score]) => {
                let barColor = 'bg-red-500';
                if (score >= 80) barColor = 'bg-emerald-500';
                else if (score >= 50) barColor = 'bg-amber-400';
                
                const itemEl = document.createElement('div');
                itemEl.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-slate-300">${label.toUpperCase()} MATCH</span>
                        <span class="text-sm font-bold text-white">${score}%</span>
                    </div>
                    <div class="ats-progress-bar-bg h-2 rounded-full overflow-hidden">
                        <div class="ats-progress-bar h-full rounded-full ${barColor}" data-score="${score}"></div>
                    </div>`;
                breakdownContainer.appendChild(itemEl);
            });

            setTimeout(() => {
                document.querySelectorAll('.ats-progress-bar').forEach(bar => {
                    bar.style.width = `${bar.dataset.score}%`;
                });
            }, 100);
        }

        // --- History Management (Preserved) ---
        function saveToHistory(entry) {
            if (!entry || !entry.data) return;
            let list = JSON.parse(localStorage.getItem('resumeHistory') || '[]');
            list.unshift(entry);
            if (list.length > 25) list = list.slice(0, 25);
            localStorage.setItem('resumeHistory', JSON.stringify(list));
            loadHistory();
        }

        function loadHistory() {
            historyList.innerHTML = '';
            const list = JSON.parse(localStorage.getItem('resumeHistory') || '[]');
            if (list.length === 0) {
                 historyList.innerHTML = `<li class="text-center text-sm text-slate-500 py-4">No analysis history found.</li>`;
                 return;
            }
            list.forEach((item, idx) => {
                const li = document.createElement('li');
                li.className = 'p-3 rounded-xl bg-slate-800 hover:bg-slate-700/70 transition-colors cursor-pointer';
                li.innerHTML = `
                    <div class="font-medium text-sm text-slate-200 truncate">${(item.jobDesc || '').split('\n')[0].slice(0, 40) || 'Tailored Result'}...</div>
                    <div class="text-xs text-slate-500 mt-1">${new Date(item.timestamp).toLocaleString()}</div>
                    <div class="flex gap-4 mt-3">
                        <button class="load-history text-sm text-blue-400 hover:text-blue-300 hover:underline transition duration-150">LOAD PROFILE</button>
                        <button class="delete-history text-sm text-red-400 hover:text-red-300 hover:underline transition duration-150">DELETE</button>
                    </div>`;
                li.querySelector('.load-history').addEventListener('click', () => {
                    populateResults(item.data);
                    jobDescInput.value = item.jobDesc;
                    historyPanel.classList.remove('translate-x-0');
                    showMessage('Loaded analysis profile.', 'info');
                });
                li.querySelector('.delete-history').addEventListener('click', (e) => {
                    e.stopPropagation();
                    list.splice(idx, 1);
                    localStorage.setItem('resumeHistory', JSON.stringify(list));
                    loadHistory();
                    showMessage('History entry deleted', 'info');
                });
                historyList.appendChild(li);
            });
        }
        
        // --- Export & Copy (Preserved) ---
        function copyToClipboard() {
            if (!tailoredResumeText) return showMessage("Nothing to copy.", "warning");
            
            const tempInput = document.createElement('textarea');
            tempInput.value = tailoredResumeText;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            showMessage("Resume text copied to clipboard!", "success");
        }

        function downloadAsPDF() {
            if (!tailoredResumeText) {
                const plain = tailoredResumeContent.innerText?.trim();
                if (plain) {
                    tailoredResumeText = plain;
                }
            }
            if (!tailoredResumeText) return showMessage("No resume content available. Run Analyze first.", "warning");
            showMessage("Generating PDF file...", "info");
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            
            const tempDiv = document.createElement('div');
            const safeText = tailoredResumeText.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            tempDiv.innerHTML = safeText.replace(/\n/g, '<br>');
            tempDiv.style.cssText = 'font-family: Inter, sans-serif; white-space: pre-wrap; font-size: 10pt; line-height: 1.5; color: #000; padding: 40pt; width: 595pt; box-sizing: border-box;';
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            document.body.appendChild(tempDiv);

            doc.html(tempDiv, {
                callback: function(doc) {
                    doc.save('ats_optimized_resume.pdf');
                    document.body.removeChild(tempDiv);
                    showMessage("PDF download complete!", "success");
                },
                margin: [40, 40, 40, 40],
                autoPaging: 'text',
                width: 515 
            });
        }

        async function downloadAsDOCX() {
            if (!tailoredResumeText) {
                const plain = tailoredResumeContent.innerText?.trim();
                if (plain) tailoredResumeText = plain;
            }
            if (!tailoredResumeText) return showMessage("No resume content available. Run Analyze first.", "warning");
            
            showMessage('DOCX feature simulated. Connect to a backend API to enable full download.', 'info');
        }
        
        // --- MOCK API FOR DEMO (Preserved) ---
        function mockApiResponse(type) {
            return new Promise(resolve => {
                setTimeout(() => {
                    if (type === 'analyze') {
                        resolve({
                            extracted_text: "Software Engineer with 5+ years of experience in Python and Django. Skilled in building scalable web applications. Based in San Francisco. Hobbies include hiking. Experienced with RESTful APIs and CI/CD pipelines.",
                            unwanted_sections: ["Hobbies include hiking.", "Based in San Francisco."],
                            matched_sections: ["Software Engineer", "Python", "RESTful APIs", "CI/CD"]
                        });
                    } else if (type === 'generate') {
                        resolve({
                            enhanced_resume: "PROFESSIONAL SUMMARY: Experienced Software Engineer with 5+ years of expertise in **Python** (Django/Flask) and JavaScript. Proven ability to design, develop, and deploy **scalable web applications** and **RESTful APIs**. Adept at implementing **CI/CD pipelines** to streamline deployment. Successfully collaborated with cross-functional teams to deliver high-quality software solutions.\n\nTECHNICAL SKILLS: * Languages: Python, JavaScript, TypeScript * Frameworks: Django, Flask, Node.js * Tools: Docker, Kubernetes, CI/CD, Git, AWS\n\nPROFESSIONAL EXPERIENCE: - Engineered high-traffic applications using **Python** and Django, serving 1M+ users monthly. - Designed and implemented robust **RESTful APIs** for client-side applications. - Automated deployment processes by creating and maintaining **CI/CD pipelines**, reducing downtime by 30%.",
                            ats_breakdown: { "Keywords": 88, "Skills": 95, "Experience": 82, "Formatting": 90 },
                            missing_keywords: ["Kubernetes", "Node.js", "TypeScript"],
                            feedback: {
                                strengths: ["Strong alignment on key technologies like Python and RESTful APIs.", "Clear, quantified achievements added to experience section.", "Excellent technical skills list."],
                                suggestions: ["Add a section detailing specific project metrics related to Kubernetes use.", "Ensure every bullet point begins with a strong action verb.", "Tailor the summary further to mention the company's specific product line."]
                            },
                            matched_sections: ["Python", "RESTful APIs", "CI/CD", "scalable web applications", "Django", "JavaScript"]
                        });
                    }
                }, 1500);
            });
        }
    </script>
</body>
</html>
